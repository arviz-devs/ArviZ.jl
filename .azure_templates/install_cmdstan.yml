parameters:
- name: version
  type: string
  default: ''
- name: dir
  type: string
  default: ''

steps:
- task: Cache@2
  inputs:
    key: cmdstan | "$(${{ parameters.version }})" | "$(Agent.OS)"
    restoreKeys: cmdstan | "$(${{ parameters.version }})" | "$(Agent.OS)"
    path: ${{ parameters.dir }}
    cacheHitVar: CMDSTAN_CACHE_RESTORED
- bash: |
    set -o xtrace
    wget -P ${{ parameters.dir }} https://github.com/stan-dev/cmdstan/releases/download/v${{ parameters.version }}/cmdstan-${{ parameters.version }}.tar.gz
    tar -xzpf ${{ parameters.dir }}/cmdstan-${{ parameters.version }}.tar.gz -C ${{ parameters.dir }}
    make -C ${{ parameters.dir }}/cmdstan-${{ parameters.version }}/ build
  displayName: 'Download and build CmdStan'
  condition: ne(variables.CMDSTAN_CACHE_RESTORED, 'true')
